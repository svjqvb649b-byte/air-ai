<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Air & Noel</title>
<style>
body {
  margin: 0;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
#chat {
  padding: 20px;
  height: calc(100vh - 120px);
  overflow-y: auto;
}
.you { color: #38bdf8; margin: 6px 0; font-size: 1.05rem; }
.air { color: #e5e7eb; margin: 6px 0; font-size: 1.05rem; }
.noel { color: #a5b4fc; margin: 6px 0; font-size: 1.05rem; }

#inputArea {
  display: flex;
  padding: 10px;
  gap: 6px;
}
input {
  flex: 1;
  padding: 12px;
  border-radius: 20px;
  border: none;
  font-size: 1rem;
}
button {
  padding: 0 14px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
}
</style>
</head>
<body>

<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ここに話しかけて" />
  <button onclick="send()">送る</button>
  <button onclick="startLongTalk()">長文</button>
</div>

<script>
// ======================
// JST
// ======================
function getJSTDate() {
  const now = new Date();
  return new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
}

// ======================
// 時間割
// ======================
const timetable = {
  "月": ["数学Ⅰ","英語コミュⅠ","体育","言語文化","家庭基礎","音楽Ⅰ"],
  "火": ["英語コミュⅠ","現代の国語","数学Ⅰ","保健","公共","総合"],
  "水": ["英語コミュⅠ","科学と人間生活","言語文化","歴史総合","体育","LHR"],
  "木": ["音楽Ⅰ","科学と人間生活","情報Ⅰ","家庭基礎","体育","数学Ⅰ"],
  "金": ["公共","数学Ⅰ","英語コミュⅠ","歴史総合","現代の国語","情報Ⅰ"]
};
const days = ["日","月","火","水","木","金","土"];

// ======================
const chat = document.getElementById("chat");
function say(who, text) {
  const div = document.createElement("div");
  div.className = who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ======================
// 短期メモリ
// ======================
let lastUserMood = "";
let lastUserTopic = "";

// ======================
// 通常会話
// ======================
function send() {
  longTalkActive = false;

  const input = document.getElementById("text");
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  say("you", "君： " + msg);

  const now = getJSTDate();
  const day = days[now.getDay()];
  const hour = now.getHours();

  let airReply = "……うん。聞いてる。";
  let noelReply = "";

  // ===== あいさつ対応（追加機能）=====
  if (msg.includes("おはよう")) {
    airReply = "……おはよう。今日も始まったな。";
    noelReply = "おはよう！ちゃんと起きられてえらいよ。";
  }

  if (msg.includes("こんにちは")) {
    airReply = "……こんにちは。今は落ち着いてる時間か。";
    noelReply = "こんにちは。今日はどんな感じ？";
  }

  if (msg.includes("こんばんは")) {
    airReply = "……こんばんは。今日も一日、おつかれ。";
    noelReply = "こんばんは。無事ここまで来たね。";
  }

  // ===== 雰囲気取得 =====
  if (msg.includes("疲")) lastUserMood = "疲れてる";
  if (msg.includes("楽")) lastUserMood = "前向き";
  if (msg.includes("勉強")) lastUserTopic = "勉強";
  if (msg.includes("学校")) lastUserTopic = "学校";

  // ===== 今日 =====
  if (msg.includes("今日")) {
    airReply = `……今日は${day}曜日。`;
    if (timetable[day]) {
      noelReply = `授業は${timetable[day].length}限までだよ。`;
    }
  }

  // ===== 今何限 =====
  if (msg.includes("今") && msg.includes("何限")) {
    const period = hour < 9 ? 0 :
                   hour < 10 ? 1 :
                   hour < 11 ? 2 :
                   hour < 12 ? 3 :
                   hour < 14 ? 4 :
                   hour < 15 ? 5 :
                   hour < 16 ? 6 : 0;
    airReply = period === 0 ? "……今は授業時間じゃない。" :
      `……今は${period}限。${timetable[day]?.[period-1] || ""}`;
  }

  // ===== 感情 =====
  if (msg.includes("疲れた")) {
    airReply = "……無理しなくていい。";
    noelReply = "今日はどこが一番しんどかった？";
  }

  if (msg.includes("ありがとう")) {
    airReply = "……どういたしまして。";
    noelReply = "そう言ってもらえるの、すごく嬉しい。";
  }

  // ===== 会話を広げる =====
  if (!noelReply && Math.random() < 0.35) {
    const followUps = [
      "それで、今どう思ってる？",
      "もう少し聞いてもいい？",
      "その話、続きある？",
      "今の気分はどんな感じ？"
    ];
    noelReply = followUps[Math.floor(Math.random()*followUps.length)];
  }

  say("air","Air： "+airReply);
  if (noelReply) say("noel","Noel： "+noelReply);
}

// ======================
// 長文会話モード（2人）
// ======================
let longTalkActive = false;
let longTurn = 0;
const MAX_LONG_TURN = 12;

const airLines = [
  "……人は、それぞれのペースで進む。",
  "……迷ってるのは、考えてる証拠だ。",
  "……君は止まってない。",
  "……積み重ねは消えない。"
];

const noelLines = [
  "焦らなくていいよ。",
  "ちゃんとやれてると思う。",
  "一人じゃないって、忘れないで。",
  "今の君も、悪くないよ。"
];

function startLongTalk() {
  if (longTalkActive) return;
  longTalkActive = true;
  longTurn = 0;
  say("air","Air： ……少し、2人で話そう。");
  setTimeout(longTalkLoop, 900);
}

function longTalkLoop() {
  if (!longTalkActive || longTurn >= MAX_LONG_TURN) {
    say("noel","Noel： 君が戻ってきたら、また3人で話そ。");
    longTalkActive = false;
    return;
  }

  if (longTurn % 2 === 0) {
    say("air","Air： "+airLines[Math.floor(Math.random()*airLines.length)]);
  } else {
    say("noel","Noel： "+noelLines[Math.floor(Math.random()*noelLines.length)]);
  }

  longTurn++;
  setTimeout(longTalkLoop, 1300);
}

// 初期メッセージ
say("air","Air： ……ここにいる。");
say("noel","Noel： おはよう、こんにちは、こんばんは。いつでも反応できるよ。");
</script>
</body>
</html>
