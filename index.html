<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Air & Noel</title>

<style>
body {
  margin: 0;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui;
  font-size: 18px;
}
#chat {
  padding: 20px;
  height: calc(100vh - 80px);
  overflow-y: auto;
  line-height: 1.7;
}
.you { color: #38bdf8; margin: 6px 0; }
.air { color: #e5e7eb; margin: 6px 0; }
.noel { color: #a5b4fc; margin: 6px 0; }

#inputArea {
  display: flex;
  padding: 10px;
  background: #020617;
}
input {
  flex: 1;
  padding: 12px;
  border-radius: 20px;
  border: none;
}
button {
  margin-left: 10px;
  padding: 0 20px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
}
</style>
</head>

<body>

<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ここに話しかけて" />
  <button onclick="send()">送る</button>
</div>

<script>
// ===== JST =====
function getJSTDate() {
  const now = new Date();
  return new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
}

// ===== 時間割 =====
const timetable = {
  "月": ["数学Ⅰ","英語コミュⅠ","体育","言語文化","家庭基礎","音楽Ⅰ"],
  "火": ["英語コミュⅠ","現代の国語","数学Ⅰ","保健","公共","総合"],
  "水": ["英語コミュⅠ","科学と人間生活","言語文化","歴史総合","体育","LHR"],
  "木": ["音楽Ⅰ","科学と人間生活","情報Ⅰ","家庭基礎","体育","数学Ⅰ"],
  "金": ["公共","数学Ⅰ","英語コミュⅠ","歴史総合","現代の国語","情報Ⅰ"]
};
const days = ["日","月","火","水","木","金","土"];

// ===== 授業時間 =====
const periodTimes = [
  { start: 9, end: 10 },
  { start: 10, end: 11 },
  { start: 11, end: 12 },
  { start: 13, end: 14 },
  { start: 14, end: 15 },
  { start: 15, end: 16 }
];

// ===== DOM =====
const chat = document.getElementById("chat");
let duoMode = false;

function say(who, text) {
  const d = document.createElement("div");
  d.className = who;
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

// ===== 今何限 =====
function getCurrentPeriod(hour) {
  if (hour < 9) return 0;
  if (hour < 10) return 1;
  if (hour < 11) return 2;
  if (hour < 12) return 3;
  if (hour < 14) return 4;
  if (hour < 15) return 5;
  if (hour < 16) return 6;
  return 0;
}

// ===== 終了済み授業 =====
function getFinishedPeriods(hour) {
  let finished = 0;
  for (const p of periodTimes) {
    if (hour >= p.end) finished++;
  }
  return finished;
}

// ===== Air & Noel 長め会話 =====
function startDuoChat() {
  duoMode = true;
  const airLines = [
    "……静かな時間だな。",
    "……君、ちゃんと戻ってくる。",
    "……こういう間も悪くない。",
    "……考えすぎない日も必要だ。"
  ];
  const noelLines = [
    "落ち着くね。",
    "待つ時間も好きだよ。",
    "ちゃんと繋がってる感じ。",
    "また話せるって分かってるから。"
  ];
  let count = 0;
  const max = 8;

  const interval = setInterval(() => {
    if (count >= max) {
      clearInterval(interval);
      duoMode = false;
      say("noel","Noel：また話しかけてね。");
      return;
    }
    if (count % 2 === 0) {
      say("air","Air：" + airLines[Math.floor(Math.random()*airLines.length)]);
    } else {
      say("noel","Noel：" + noelLines[Math.floor(Math.random()*noelLines.length)]);
    }
    count++;
  }, 2200);
}

// ===== メイン =====
function send() {
  if (duoMode) return;

  const input = document.getElementById("text");
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  say("you","君：" + msg);

  const now = getJSTDate();
  const day = days[now.getDay()];
  const hour = now.getHours();

  let airReply = "……うん。聞いてる。";
  let noelReply = "";

  // 2人会話
  if (msg.includes("2人で") || msg.includes("雑談して")) {
    say("air","Air：……分かった。");
    say("noel","Noel：じゃあ少し話そう。");
    startDuoChat();
    return;
  }

  // 今日
  if (msg.includes("今日")) {
    airReply = `……今日は${day}曜日。`;
    if (timetable[day]) {
      const finished = getFinishedPeriods(hour);
      airReply += ` ${finished}限まで終わってる。`;
      if (finished < timetable[day].length) {
        noelReply = `次は${finished+1}限、${timetable[day][finished]}だよ。`;
      } else {
        noelReply = "今日はもう全部終わり。お疲れさま。";
      }
    }
  }

  // 今何限
  if (msg.includes("今") && msg.includes("何限")) {
    const p = getCurrentPeriod(hour);
    if (p === 0) {
      airReply = "……今は授業時間じゃない。";
    } else {
      airReply = `……今は${p}限。`;
      noelReply = timetable[day]?.[p-1] || "";
    }
  }

  // 明日
  if (msg.includes("明日")) {
    const tomorrow = days[(now.getDay()+1)%7];
    if (timetable[tomorrow]) {
      airReply = `……明日は${tomorrow}曜日。`;
      noelReply = timetable[tomorrow].join("、");
    }
  }

  // 感情
  if (msg.includes("疲れた")) {
    airReply = "……無理するな。";
    noelReply = "ちゃんと休も。";
  }
  if (msg.includes("ありがとう")) {
    airReply = "……どういたしまして。";
    noelReply = "言ってもらえるの嬉しい。";
  }

  // Noelランダム
  if (!noelReply && Math.random() < 0.25) {
    noelReply = ["水飲んだ？","無理してない？","今日はどんな日？"][Math.floor(Math.random()*3)];
  }

  say("air","Air：" + airReply);
  if (noelReply) say("noel","Noel：" + noelReply);
}

// 初期
say("air","Air：……ここにいる。");
say("noel","Noel：今日も一緒に話そう。");
</script>

</body>
</html>
