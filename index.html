<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air & Noel</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui;
}
#chat {
  padding: 16px;
  height: calc(100vh - 90px);
  overflow-y: auto;
}
.you { color: #38bdf8; margin: 10px 0; }
.air { color: #e5e7eb; margin: 10px 0; }
.noel { color: #a5b4fc; margin: 10px 0; }

#inputArea {
  display: flex;
  padding: 10px;
}
input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 20px;
  border: none;
}
button {
  margin-left: 8px;
  padding: 0 18px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
}
</style>
</head>

<body>
<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ã“ã“ã«è©±ã—ã‹ã‘ã¦">
  <button onclick="send()">é€ã‚‹</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("text");

function say(who, text) {
  const div = document.createElement("div");
  div.className = who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== ğŸ§  çŸ­æœŸè¨˜æ†¶ ===== */
const memory = [];
const MEMORY_LIMIT = 5;

function remember(msg) {
  memory.push(msg);
  if (memory.length > MEMORY_LIMIT) memory.shift();
}

function lastMemory() {
  return memory.length ? memory[memory.length - 1] : "";
}

/* ===== æ™‚é–“å‰² ===== */
const timetable = {
  1:["å›½èª","æ•°å­¦","è‹±èª","ç†ç§‘","ç¤¾ä¼š"],
  2:["æ•°å­¦","è‹±èª","ä½“è‚²","å›½èª","ç†ç§‘"],
  3:["è‹±èª","ç¤¾ä¼š","æ•°å­¦","éŸ³æ¥½"],
  4:["ç†ç§‘","å›½èª","ç¾è¡“","æ•°å­¦"],
  5:["ç¤¾ä¼š","è‹±èª","å®¶åº­ç§‘"]
};
const dayNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

/* ===== æ™‚é™ ===== */
const periods = [
  {name:"1é™ç›®",start:8*60+50,end:9*60+40},
  {name:"2é™ç›®",start:9*60+50,end:10*60+40},
  {name:"3é™ç›®",start:10*60+50,end:11*60+40},
  {name:"4é™ç›®",start:12*60+50,end:13*60+40},
  {name:"æ˜¼ä¼‘ã¿",start:13*60+40,end:14*60+20},
  {name:"5é™ç›®",start:14*60+25,end:15*60+15},
  {name:"6é™ç›®",start:15*60+15,end:16*60}
];

/* ===== ãƒ¢ãƒ¼ãƒ‰ç®¡ç† ===== */
let duoMode = false;
let duoTimer = null;
let turn = 0;
let idleTimer = null;
const IDLE_TIME = 30000;

function resetIdle() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if (!duoMode) startDuo(true);
  }, IDLE_TIME);
}

function stopModes() {
  clearInterval(duoTimer);
  duoMode = false;
  turn = 0;
}

/* ===== 2äººä¼šè©± ===== */
const duoAir = [
  "â€¦â€¦å°‘ã—é™ã‹ã ã€‚",
  "â€¦â€¦ä»Šæ—¥ã¯é•·ã‹ã£ãŸã€‚",
  "â€¦â€¦ç„¡ç†ã¯ã—ã¦ãªã„ï¼Ÿ",
  "â€¦â€¦ã“ã“ã«æ¥ã¦ãã‚ŒãŸã€‚"
];
const duoNoel = [
  "ã†ã‚“ã€‚",
  "ã§ã‚‚ã€ãã‚Œã§ã„ã„ã€‚",
  "ã¡ã‚ƒã‚“ã¨é€²ã‚“ã§ã‚‹ã€‚",
  "æ¥ã¦ãã‚ŒãŸã ã‘ã§ã€‚"
];

function startDuo(auto=false) {
  stopModes();
  duoMode = true;
  say("air", auto ? "Air : â€¦â€¦é™ã‹ã ã‹ã‚‰ã€å°‘ã—è©±ãã†ã€‚" : "Air : â€¦â€¦å°‘ã—è©±ãã†ã€‚");
  duoTimer = setInterval(() => {
    const i = Math.floor(turn/2);
    if (turn % 2 === 0)
      say("air","Air : "+duoAir[i % duoAir.length]);
    else
      say("noel","Noel : "+duoNoel[i % duoNoel.length]);
    turn++;
  }, 4500);
}

/* ===== è£ç›¸è«‡ï¼‹çŸ­æœŸè¨˜æ†¶åæ˜  ===== */
function consult(msg) {
  let mood = "normal";
  if (/ç–²ã‚Œ|ã¤ã‹ã‚Œ|ã—ã‚“ã©|ç„¡ç†|æœ€æ‚ª/.test(msg)) mood = "tired";

  const prev = lastMemory();

  let airReply = "â€¦â€¦èã„ã¦ã‚‹ã€‚";
  let noelAddon = "ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã€‚";

  if (prev && prev !== msg) {
    airReply = "â€¦â€¦ã•ã£ãã®è©±ã€å°‘ã—ç¶šã„ã¦ã‚‹æ°—ãŒã™ã‚‹ã€‚";
    noelAddon = "ã€Œ"+prev+"ã€ã®ã“ã¨ã ã‚ˆã­ã€‚";
  }

  if (mood === "tired") {
    airReply = "â€¦â€¦ä»Šæ—¥ã¯ã€ãã¤ã‹ã£ãŸã‚“ã ã­ã€‚";
    noelAddon = "ç„¡ç†ã—ãªãã¦ã„ã„ã‚ˆã€‚";
  }

  return { airReply, noelAddon };
}

/* ===== æ©Ÿèƒ½ ===== */
function showTodaySchedule() {
  const d = new Date();
  const day = d.getDay();
  const list = timetable[day];
  if (!list) {
    say("air","Air : â€¦â€¦ä»Šæ—¥ã¯æˆæ¥­ãªã„æ—¥ã€‚");
    say("noel","Noel : ã‚†ã£ãã‚Šã—ã‚ˆã€‚");
    return;
  }
  say("air","Air : â€¦â€¦ä»Šæ—¥ã¯"+dayNames[day]+"æ›œæ—¥ã€‚");
  say("noel","Noel : "+list.join("ã€")+"ã ã‚ˆã€‚");
}

function nextPeriod() {
  const now = new Date();
  const m = now.getHours()*60 + now.getMinutes();
  for (const p of periods) {
    if (m < p.start) { say("air","Air : â€¦â€¦æ¬¡ã¯"+p.name+"ã€‚"); return; }
    if (m >= p.start && m < p.end) { say("air","Air : â€¦â€¦ä»Šã¯"+p.name+"ã€‚"); return; }
  }
  say("air","Air : â€¦â€¦ä»Šæ—¥ã¯ã‚‚ã†çµ‚ã‚ã‚Šã€‚");
}

/* ===== ãƒ¡ã‚¤ãƒ³ ===== */
function send() {
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  resetIdle();
  if (duoMode) stopModes();

  say("you","å› : "+msg);
  remember(msg);

  if (msg.includes("2äºº") || msg.includes("è©±ã—ã¦")) { startDuo(); return; }
  if (msg.includes("æ¬¡ã¯ä½•é™")) { nextPeriod(); return; }
  if (msg.includes("æ™‚é–“å‰²") || msg.includes("æˆæ¥­")) { showTodaySchedule(); return; }

  if (msg.includes("ãŠã¯ã‚ˆã†") || msg.includes("ã“ã‚“ã«ã¡ã¯") || msg.includes("ã“ã‚“ã°ã‚“ã¯")) {
    say("air","Air : â€¦â€¦"+msg+"ã€‚");
    say("noel","Noel : ä»Šæ—¥ã‚‚è©±ã›ã¦ã‚ˆã‹ã£ãŸã€‚");
    return;
  }

  const res = consult(msg);
  say("air","Air : "+res.airReply);
  say("noel","Noel : "+res.noelAddon);
}

/* ===== åˆæœŸ ===== */
say("air","Air : â€¦â€¦ã“ã“ã«ã„ã‚‹ã€‚");
say("noel","Noel : ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã€‚");
resetIdle();
</script>
</body>
</html>
