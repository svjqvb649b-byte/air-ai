<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Air & Noel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}

#chat {
  padding: 16px;
  height: calc(100vh - 120px);
  overflow-y: auto;
}

.you { color: #38bdf8; margin: 10px 0; }
.air { color: #e5e7eb; margin: 10px 0; }
.noel { color: #a5b4fc; margin: 10px 0; }

#inputArea {
  display: flex;
  padding: 10px;
}

input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 20px;
  border: none;
  font-size: 16px;
}

button {
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
  font-size: 15px;
}
</style>
</head>

<body>

<!-- ğŸ”” é€šçŸ¥ON/OFF -->
<div style="padding:8px;text-align:center;">
  <button onclick="toggleNotify()" id="notifyBtn">ğŸ”• é€šçŸ¥ï¼šOFF</button>
</div>

<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ã“ã“ã«è©±ã—ã‹ã‘ã¦">
  <button onclick="send()">é€ã‚‹</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("text");

/* ===== è¡¨ç¤º ===== */
function say(who, text) {
  const div = document.createElement("div");
  div.className = who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== æ™‚é–“å‰² ===== */
const timetable = {
  1: ["æ•°å­¦â… ","è‹±èªã‚³ãƒŸãƒ¥â… ","ä½“è‚²","è¨€èªæ–‡åŒ–","å®¶åº­åŸºç¤","éŸ³æ¥½â… "],
  2: ["è‹±èªã‚³ãƒŸãƒ¥â… ","ç¾ä»£ã®å›½èª","æ•°å­¦â… ","ä¿å¥","å…¬å…±","ç·åˆ"],
  3: ["è‹±èªã‚³ãƒŸãƒ¥â… ","ç§‘å­¦ã¨äººé–“ç”Ÿæ´»","è¨€èªæ–‡åŒ–","æ­´å²ç·åˆ","ä½“è‚²","LHR"],
  4: ["éŸ³æ¥½â… ","ç§‘å­¦ã¨äººé–“ç”Ÿæ´»","æƒ…å ±â… ","å®¶åº­åŸºç¤","ä½“è‚²","æ•°å­¦â… "],
  5: ["å…¬å…±","æ•°å­¦â… ","è‹±èªã‚³ãƒŸãƒ¥â… ","æ­´å²ç·åˆ","ç¾ä»£ã®å›½èª","æƒ…å ±â… "]
};
const dayNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

/* ===== æ™‚é™ ===== */
const periods = [
  { name:"1é™ç›®", start:"08:50", end:"09:40" },
  { name:"2é™ç›®", start:"09:50", end:"10:40" },
  { name:"3é™ç›®", start:"10:50", end:"11:40" },
  { name:"4é™ç›®", start:"12:50", end:"13:40" },
  { name:"æ˜¼ä¼‘ã¿", start:"13:40", end:"14:20" },
  { name:"5é™ç›®", start:"14:25", end:"15:15" },
  { name:"6é™ç›®", start:"15:15", end:"16:00" }
];

function nowPeriodIndex() {
  const now = new Date();
  const t = now.getHours()*60 + now.getMinutes();
  for (let i=0;i<periods.length;i++) {
    const [sh,sm]=periods[i].start.split(":").map(Number);
    const [eh,em]=periods[i].end.split(":").map(Number);
    if (t>=sh*60+sm && t<eh*60+em) return i;
  }
  return -1;
}

/* ===== çŸ­æœŸè¨˜æ†¶ ===== */
const memory=[];
function remember(m){ memory.push(m); if(memory.length>5) memory.shift(); }

/* ===== 2äººä¼šè©± ===== */
let duoMode=false, duoTimer=null, turn=0;
const duoAir=["â€¦â€¦è½ã¡ç€ã„ã¦ã‚‹ã€‚","â€¦â€¦æ™‚é–“ã¯é€²ã‚“ã§ã‚‹ã€‚","â€¦â€¦å¤§ä¸ˆå¤«ãã†ã€‚"];
const duoNoel=["ã†ã‚“ã€‚","ãã®ã¾ã¾ã§ã„ã„ã€‚","ã¡ã‚ƒã‚“ã¨é€²ã‚“ã§ã‚‹ã€‚"];

function startDuo(){
  stopDuo();
  duoMode=true;
  say("air","Air : â€¦â€¦å°‘ã—è©±ãã†ã€‚");
  duoTimer=setInterval(()=>{
    const i=Math.floor(turn/2);
    if(turn%2===0) say("air","Air : "+duoAir[i%duoAir.length]);
    else say("noel","Noel : "+duoNoel[i%duoNoel.length]);
    turn++;
  },4500);
}
function stopDuo(){ clearInterval(duoTimer); duoMode=false; turn=0; }

/* ===== è‡ªå‹•ä¼šè©± ===== */
let idleTimer=null;
function resetIdle(){
  clearTimeout(idleTimer);
  idleTimer=setTimeout(()=>{ if(!duoMode) startDuo(); },20000);
}

/* ===== é€šçŸ¥ ===== */
let notifyEnabled=false;
const moveSubjects=["ä½“è‚²","éŸ³æ¥½â… ","æƒ…å ±â… ","ç§‘å­¦ã¨äººé–“ç”Ÿæ´»","å®¶åº­åŸºç¤"];

function toggleNotify(){
  if(!("Notification"in window)){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    return;
  }
  if(!notifyEnabled){
    Notification.requestPermission().then(p=>{
      if(p==="granted"){
        notifyEnabled=true;
        notifyBtn.textContent="ğŸ”” é€šçŸ¥ï¼šON";
        say("noel","Noel : é€šçŸ¥ã€ã‚ªãƒ³ã«ã—ãŸã‚ˆã€‚");
      }
    });
  }else{
    notifyEnabled=false;
    notifyBtn.textContent="ğŸ”• é€šçŸ¥ï¼šOFF";
    say("air","Air : â€¦â€¦é€šçŸ¥ã€ã‚ªãƒ•ã€‚");
  }
}

function checkMoveNotify(){
  if(!notifyEnabled) return;
  const now=new Date();
  const day=now.getDay();
  const list=timetable[day];
  if(!list) return;

  const nowMin=now.getHours()*60+now.getMinutes();
  periods.forEach((p,i)=>{
    const [sh,sm]=p.start.split(":").map(Number);
    const startMin=sh*60+sm;
    if(startMin-nowMin===5 && moveSubjects.includes(list[i])){
      new Notification("Air & Noel",{
        body:`Noelï¼šæ¬¡ã¯ã€Œ${list[i]}ã€ã€‚ç§»å‹•æ•™å®¤ã ã‚ˆã€‚`
      });
    }
  });
}
setInterval(checkMoveNotify,60000);

/* ===== æ©Ÿèƒ½ ===== */
function showToday(){
  const d=new Date(), day=d.getDay(), list=timetable[day];
  if(!list){ say("air","Air : â€¦â€¦ä»Šæ—¥ã¯æˆæ¥­ãªã„ã€‚"); return; }
  say("air",`Air : â€¦â€¦ä»Šæ—¥ã¯${dayNames[day]}æ›œæ—¥ã€‚`);
  say("noel","Noel : "+list.join("ã€"));
}

function showNext(){
  const d=new Date(), day=d.getDay(), list=timetable[day];
  if(!list){ say("air","Air : â€¦â€¦ä»Šæ—¥ã¯æˆæ¥­ãªã„ã€‚"); return; }
  const i=nowPeriodIndex();
  if(i<0){ say("air","Air : â€¦â€¦ä»Šã¯æˆæ¥­å¤–ã€‚"); return; }
  say("air",`Air : â€¦â€¦ä»Šã¯${periods[i].name}ã€‚`);
  say("noel",`Noel : ${list[i]}ã ã‚ˆã€‚`);
}

/* ===== é€ä¿¡ ===== */
function send(){
  const msg=input.value.trim();
  if(!msg) return;
  input.value="";
  resetIdle(); stopDuo();
  say("you","å› : "+msg);
  remember(msg);

  if(msg.includes("2äºº")){ startDuo(); return; }
  if(msg.includes("æ™‚é–“å‰²")){ showToday(); return; }
  if(msg.includes("æ¬¡ã¯")){ showNext(); return; }
  if(msg.includes("ãŠã¯ã‚ˆã†")){
    say("air","Air : â€¦â€¦ãŠã¯ã‚ˆã†ã€‚");
    say("noel","Noel : ä»Šæ—¥ã‚‚ä¸€ç·’ã«ã€‚");
    return;
  }
  say("air","Air : â€¦â€¦èã„ã¦ã‚‹ã€‚");
}

/* ===== åˆæœŸ ===== */
say("air","Air : â€¦â€¦ã“ã“ã«ã„ã‚‹ã€‚");
say("noel","Noel : ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã€‚");
resetIdle();
</script>
</body>
</html>
