<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air & Noel</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui;
}
#chat {
  padding: 16px;
  height: calc(100vh - 90px);
  overflow-y: auto;
}
.you { color: #38bdf8; margin: 10px 0; }
.air { color: #e5e7eb; margin: 10px 0; }
.noel { color: #a5b4fc; margin: 10px 0; }

#inputArea {
  display: flex;
  padding: 10px;
}
input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 20px;
  border: none;
}
button {
  margin-left: 8px;
  padding: 0 18px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
}
</style>
</head>

<body>
<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ここに話しかけて">
  <button onclick="send()">送る</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("text");

function say(who, text) {
  const div = document.createElement("div");
  div.className = who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== 時間割 ===== */
const timetable = {
  1:["国語","数学","英語","理科","社会"],
  2:["数学","英語","体育","国語","理科"],
  3:["英語","社会","数学","音楽"],
  4:["理科","国語","美術","数学"],
  5:["社会","英語","家庭科"]
};
const dayNames = ["日","月","火","水","木","金","土"];

/* ===== 時限 ===== */
const periods = [
  {name:"1限目",start:8*60+50,end:9*60+40},
  {name:"2限目",start:9*60+50,end:10*60+40},
  {name:"3限目",start:10*60+50,end:11*60+40},
  {name:"4限目",start:12*60+50,end:13*60+40},
  {name:"昼休み",start:13*60+40,end:14*60+20},
  {name:"5限目",start:14*60+25,end:15*60+15},
  {name:"6限目",start:15*60+15,end:16*60}
];

/* ===== モード管理 ===== */
let duoMode = false;
let duoTimer = null;
let turn = 0;
let idleTimer = null;
const IDLE_TIME = 30000;

function resetIdle() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if (!duoMode) startDuo(true);
  }, IDLE_TIME);
}

function stopModes() {
  clearInterval(duoTimer);
  duoMode = false;
  turn = 0;
}

/* ===== 2人会話 ===== */
const duoAir = [
  "……少し静かだ。",
  "……今日は長かった。",
  "……無理はしてない？",
  "……ここに来てくれた。"
];
const duoNoel = [
  "うん。",
  "でも、それでいい。",
  "ちゃんと進んでる。",
  "来てくれただけで。"
];

function startDuo(auto=false) {
  stopModes();
  duoMode = true;
  say("air", auto ? "Air : ……静かだから、少し話そう。" : "Air : ……少し話そう。");
  duoTimer = setInterval(() => {
    const i = Math.floor(turn/2);
    if (turn % 2 === 0)
      say("air","Air : "+duoAir[i % duoAir.length]);
    else
      say("noel","Noel : "+duoNoel[i % duoNoel.length]);
    turn++;
  }, 4500);
}

/* ===== 裏相談（分析＋反映） ===== */
function consult(msg) {
  let mood = "normal";
  let intent = "talk";

  if (/疲れ|つかれ|しんど|無理|最悪/.test(msg)) mood = "tired";
  if (/[？?]|どう|なに/.test(msg)) intent = "question";

  // Air：判断
  let airReply = {
    normal: "……聞いてる。",
    tired: "……今日は、きつかったんだね。",
  }[mood];

  // Noel：言い方調整
  let noelAddon = {
    normal: "ゆっくりでいいよ。",
    tired: "無理しなくていいよ。",
  }[mood];

  if (intent === "question") {
    airReply = "……一緒に考えよう。";
    noelAddon = "落ち着いて見てみよ。";
  }

  return { airReply, noelAddon };
}

/* ===== 機能 ===== */
function showTodaySchedule() {
  const d = new Date();
  const day = d.getDay();
  const list = timetable[day];
  if (!list) {
    say("air","Air : ……今日は授業ない日。");
    say("noel","Noel : ゆっくりしよ。");
    return;
  }
  say("air","Air : ……今日は"+dayNames[day]+"曜日。");
  say("noel","Noel : "+list.join("、")+"だよ。");
}

function nextPeriod() {
  const now = new Date();
  const m = now.getHours()*60 + now.getMinutes();
  for (const p of periods) {
    if (m < p.start) { say("air","Air : ……次は"+p.name+"。"); return; }
    if (m >= p.start && m < p.end) { say("air","Air : ……今は"+p.name+"。"); return; }
  }
  say("air","Air : ……今日はもう終わり。");
}

/* ===== メイン ===== */
function send() {
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  resetIdle();
  if (duoMode) stopModes();

  say("you","君 : "+msg);

  if (msg.includes("2人") || msg.includes("話して")) { startDuo(); return; }
  if (msg.includes("次は何限")) { nextPeriod(); return; }
  if (msg.includes("時間割") || msg.includes("授業")) { showTodaySchedule(); return; }

  if (msg.includes("おはよう") || msg.includes("こんにちは") || msg.includes("こんばんは")) {
    say("air","Air : ……"+msg+"。");
    say("noel","Noel : 今日も話せてよかった。");
    return;
  }

  // ★ 裏相談を反映した返答
  const res = consult(msg);
  say("air","Air : "+res.airReply);
  say("noel","Noel : "+res.noelAddon);
}

/* ===== 初期 ===== */
say("air","Air : ……ここにいる。");
say("noel","Noel : いつでも話しかけて。");
resetIdle();
</script>
</body>
</html>
