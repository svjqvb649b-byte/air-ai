<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air & Noel</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #020617;
  color: #e5e7eb;
  font-family: system-ui, -apple-system;
  font-size: 18px;
}

#chat {
  padding: 20px;
  height: calc(100vh - 140px);
  overflow-y: auto;
  line-height: 1.8;
}

.you  { color: #38bdf8; margin: 12px 0; }
.air  { color: #e5e7eb; margin: 12px 0; }
.noel { color: #a5b4fc; margin: 12px 0; }

#inputArea {
  display: flex;
  padding: 10px;
}

input {
  flex: 1;
  padding: 14px;
  border-radius: 20px;
  border: none;
  font-size: 1rem;
}

button {
  margin-left: 6px;
  padding: 0 14px;
  border-radius: 20px;
  border: none;
  background: #38bdf8;
  color: #020617;
}
</style>
</head>

<body>

<div id="chat"></div>

<div id="inputArea">
  <input id="text" placeholder="ここに話しかけて">
  <button onclick="send()">送る</button>
  <button onclick="toggleStory()">長文</button>
  <button onclick="toggleDuo()">2人</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("text");

function say(who, text) {
  const div = document.createElement("div");
  div.className = who;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== 時間割 ===== */
const timetable = {
  "月": ["国語","数学","英語","理科","体育"],
  "火": ["数学","社会","英語","音楽","美術"],
  "水": ["英語","理科","国語","技術","総合"],
  "木": ["社会","数学","英語","体育","理科"],
  "金": ["国語","数学","社会","英語"]
};

const days = ["日","月","火","水","木","金","土"];

function today() {
  return days[new Date().getDay()];
}

function currentPeriod() {
  const h = new Date().getHours();
  if (h < 9) return 0;
  if (h < 10) return 1;
  if (h < 11) return 2;
  if (h < 12) return 3;
  if (h < 14) return 4;
  if (h < 15) return 5;
  return -1;
}

/* ===== 通常会話 ===== */
function send() {
  if (storyMode) stopStory(true);
  if (duoMode) stopDuo(true);

  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";

  say("you", "君： " + msg);

  let air = null;
  let noel = null;

  const d = today();
  const p = currentPeriod();

  /* 時間割 */
  if (msg.includes("今日の時間割")) {
    air = "今日は" + d + "曜日。";
    noel = timetable[d]
      ? "授業は「" + timetable[d].join("、") + "」だよ。"
      : "今日は授業はないね。";
  }
  else if (msg.includes("今何限")) {
    air = "時刻を基準に判定。";
    noel = p > 0 ? "今は" + p + "限目だよ。" : "今は授業時間外。";
  }
  else if (msg.includes("次の授業")) {
    air = "次を確認。";
    noel = (timetable[d] && p >= 0 && timetable[d][p])
      ? "次は「" + timetable[d][p] + "」。"
      : "次は休憩でいい。";
  }
  else if (msg.includes("時間割")) {
    air = "曜日指定を検出。";
    for (const day in timetable) {
      if (msg.includes(day)) {
        noel = day + "曜は「" + timetable[day].join("、") + "」。";
      }
    }
  }
  /* 感情 */
  else if (msg.includes("疲れた")) {
    air = "疲労を検知。";
    noel = "今日はここまででも十分だよ。";
  }
  /* 雑談 */
  else {
    if (Math.random() < 0.5) {
      air = "内容を受理。";
    } else {
      noel = "うん、聞いてるよ。";
    }
  }

  if (air)  say("air",  "Air： " + air);
  if (noel) say("noel", "Noel： " + noel);
}

/* ===== 長文モード ===== */
let storyMode = false;
let storyTimer = null;
let storyTurn = 0;

const airStory = [
  "学校は消耗が前提。",
  "耐えた事実は残る。",
  "今日は生存確認で十分。"
];

const noelStory = [
  "ちゃんと来た、それでいい。",
  "無理しなくて大丈夫。",
  "今日は休んでもいい日。"
];

function toggleStory() {
  if (duoMode) stopDuo(false);
  storyMode = !storyMode;

  if (storyMode) {
    say("noel", "Noel： 長文モード開始。");
    input.disabled = true;
    storyTimer = setInterval(() => {
      if (storyTurn % 2 === 0)
        say("air", "Air： " + airStory[(storyTurn/2)%airStory.length]);
      else
        say("noel", "Noel： " + noelStory[(storyTurn/2)%noelStory.length]);
      storyTurn++;
    }, 4000);
  } else stopStory(false);
}

function stopStory(byUser) {
  clearInterval(storyTimer);
  storyMode = false;
  storyTurn = 0;
  input.disabled = false;
  if (byUser) {
    say("air", "Air： 介入を確認。");
    say("noel", "Noel： おかえり。");
  }
}

/* ===== 2人会話 ===== */
let duoMode = false;
let duoTimer = null;
let duoTurn = 0;

const duoAir = [
  "……彼は十分やっている。",
  "……判断は合理的。",
  "……今日はこれでいい。"
];

const duoNoel = [
  "うん、ちゃんと分かってる。",
  "少しずつでいい。",
  "今日は守れたね。"
];

function toggleDuo() {
  if (storyMode) stopStory(false);
  duoMode = !duoMode;

  if (duoMode) {
    say("air", "Air： 内部会話モードへ。");
    input.disabled = true;
    duoTimer = setInterval(() => {
      if (duoTurn % 2 === 0)
        say("air", "Air： " + duoAir[Math.floor(duoTurn/2)%duoAir.length]);
      else
        say("noel", "Noel： " + duoNoel[Math.floor(duoTurn/2)%duoNoel.length]);
      duoTurn++;
    }, 4500);
  } else stopDuo(false);
}

function stopDuo(byUser) {
  clearInterval(duoTimer);
  duoMode = false;
  duoTurn = 0;
  input.disabled = false;
  if (byUser) say("noel", "Noel： 戻ってきたね。");
}

/* 初期表示 */
say("air", "Air： 起動完了。");
say("noel", "Noel： 今日も一緒にやろう。");
</script>

</body>
</html>
